<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>楼间对打天线布放位置辅助计算工具</title>
    <script src="resource/bootstrap/js/bootstrap.min.js"></script>
    <link href="resource/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
      .title {
        height: 40px;
        background-color: #4472c4;
        color: white;
        text-align: center;
        font-weight: bold;
        line-height: 40px;
      }
      .table{
        width:100%;
      }
      .table th{
        /*border-right:1px solid grey;*/
        width:60px;
        text-align: center;
        vertical-align: middle;
      }
      .table td{
        /*border-right:1px solid grey;*/
        width:60px;
        text-align: center;
        vertical-align: middle;
      }

    </style>
  </head>
  <body style="width: 900px;background-color: #ffffff;overflow-y: hidden;">
    <div style="background-color: #f2f2f2;width:100%;height: 100%;padding:0px 5px 0px 5px;">
      <div>
        <div style="width:100%;height:600px;display:inline-block;background-color: #ffffff;vertical-align: top;">
<!--          左-->
          <div class="title">楼间对打天线布放位置辅助计算工具V1.0</div>
          <div style="padding:0px 5px 0px 5px;">
            <div>
              <h4>基本信息</h4>
              <table border="0" cellpadding="0" class="table">
                <tr>
                  <td>覆盖楼宇高度(m)</td>
                  <td>与对打楼宇间距(m)</td>
                  <td>水平波瓣角(°)</td>
                  <td>垂直波瓣角(°)</td>
                  <td>天线口功率(dbm)</td>
                  <td>天线增益(dbm)</td>
                  <td></td>
                  <td style="background-color: #0e90d2;color:white;font-weight: bold;">频段(Mhz)</td>
                </tr>
                <tr>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_H" value="60"></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_AH" value="30"></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_a" value="30"></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_b" value="10"></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_P" value="10"></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_G" value="15"></td>
                  <td></td>
                  <td><input type="text" class="form-control" placeholder="" style="width:60px;" id="input_F" value="900"></td>
                </tr>
              </table>

            </div>
            <div style="text-align: right;">
              <button style="width:100px;height:35px;" class="btn btn-xs btn-warning" id="btn_reset">重置</button>
              <button style="width:100px;height:35px;" class="btn btn-xs btn-primary" id="btn_add">添加</button>
<!--              <button style="width:100px;height:35px;" class="btn btn-xs btn-success" id="btn_evaluation">开始计算</button>-->
            </div>

            <div style="padding:10px 270px 5px 10px;">
              <span style="font-size: 17.5px;font-family: inherit; font-weight: bold; line-height: 20px; color: inherit; text-rendering: optimizelegibility;">数据视图</span>
              <span class="pull-right" style="font-size: 17.5px ;font-family: inherit; font-weight: bold; line-height: 20px; color: inherit; text-rendering: optimizelegibility;">计算结果</span>
            </div>

            <div class="row" style="padding: 5px 0px 5px 20px;">
              <div class="col-md-12" style="max-height: 340px;overflow-y: auto;">
              <table class="table table-striped table-bordered text-center" id="table">
                <thead>
                <tr>
                  <th style="width:5%;">序号</th>
                  <th>覆盖楼宇高度(m)</th>
                  <th>与对打楼宇间距(m)</th>
                  <th>水平波瓣角(°)</th>
                  <th>垂直波瓣角(°)</th>
                  <th>天线口功率(dbm)</th>
                  <th>天线增益(dbm)</th>
                  <th style="background-color: yellow;">建议天线与楼边距离(m)</th>
                  <th style="background-color: yellow;">建议天线挂高(m)</th>
                  <th style="background-color: #ffaa21;">实际可满足天线挂高(m)</th>
                  <th style="background-color: yellow;">建议天线俯仰角(°）</th>
                  <th style="background-color: yellow;">中心点RSRP(dbm)</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 自定义右键菜单dom -->
    <div class="contextMenu" id="myMenu1">
      <ul>
        <li id="clear-current">清除当前行</li>
        <li id="clear-all">清除所有行</li>
      </ul>
    </div>

    <template id="template">
      <tr class="tr">
        <td style="width:5%;">{{number}}</td>
        <td>{{H}}</td>
        <td>{{A}}</td>
        <td>{{a}}</td>
        <td>{{b}}</td>
        <td>{{P}}</td>
        <td>{{G}}</td>
        <td>{{X}}</td>
        <td>{{Y}}</td>
        <td style="padding-bottom:0px;"><input type="text" class="input_M" placeholder="" style="width:60px;border:0px;" value="{{M}}"></td>
        <td>{{Q}}</td>
        <td>{{Z}}</td>
      </tr>
    </template>
    <!-- You can also require other files to run in this process -->
    <script src="./renderer.js"></script>
    <script src="./resource/jquery.min.js"></script>
    <script src="./resource/layer/layer.js"></script>
    <script src="./resource/jquery.contextmenu.r2.js"></script>

    <script type="text/javascript">


      $().ready(function () {
        let number=1;
        let dataSet=[];

        $("#btn_add").click(function () {
          if(!$("#input_H").val() ||!$("#input_AH").val()|| !$("#input_a").val()|| !$("#input_b").val()
          ||!$("#input_P").val()||!$("#input_G").val()||!$("#input_F").val()){
            layer.alert("请完整填写数据");
            return;
          }
          let item = {
            number:number++,
            H:$("#input_H").val(),
            A:$("#input_AH").val(),
            a:$("#input_a").val(),
            b:$("#input_b").val(),
            P:$("#input_P").val(),
            G:$("#input_G").val(),
            F:$("#input_F").val(),
            M:0
          };
          item["X"]=(parseFloat(item.A)*Math.tan(parseFloat(item.a)*Math.PI/180/2)).toFixed(2);//X=A*tan(a/2)
          item["Y"]=(parseFloat(item.H)-parseFloat(item.A)*Math.tan(parseFloat(item.b)*Math.PI/180/2)).toFixed(2);//Y=H-A*tan(b/2)
          item["Q"]=(Math.atan((parseFloat(item.H)-parseFloat(item.M))/parseFloat(item.A))*180/Math.PI-(parseFloat(item.b)/2)).toFixed(2);//Q=arctan[(H-Y)/A] - b/2
          item["Z"]=(parseFloat(item.P)+parseFloat(item.G)-20*Math.log10(parseFloat(item.F))-20*Math.log10(parseFloat(item.A)/Math.cos(parseFloat(item.Q)*Math.PI/180)/1000)-32.45).toFixed(2);//Z=P+G-20lgF-20lg(A/1000)-32.45

          dataSet.push(item);
          renderer();
        });
        $("#btn_reset").click(function () {
          $("input").val("");
          dataSet=[];
          renderer();
        });
        $("#btn_evaluation").click(function () {

        });

        /**
         * 渲染表格数据
         */
        function renderer() {
          $("#table tbody").empty();
          for(let i=0;i<dataSet.length;i++){
            let data = dataSet[i];
            let tr=$("#template").html();
            for(let key in data){
              tr=tr.replace("{{"+key+"}}",data[key]);
            }
            $(tr).attr("item",data);
            $("#table tbody").append(tr);

            //所有class为demo1的span标签都会绑定此右键菜单
            $('#table tbody tr').contextMenu('myMenu1',
                {
                  bindings:
                          {
                            'clear-current': function(t) {
                              let number = $(t).children()[0].innerText;
                              removeArray(dataSet,{number:number});
                              t.remove();

                            },
                            'clear-all': function(t) {
                              number=1;
                              dataSet=[];
                              renderer();
                            }
                          }
                });
            $(".input_M").keyup(function () {
              layer.load();
              let tr=this.closest("tr");
              let number =tr.children[0].innerText;

              let index=getIndex(dataSet,{number:number});
              let item = dataSet[index];
              item.M=this.value;
              item["Q"]=(Math.atan((parseFloat(item.H)-parseFloat(item.M))/parseFloat(item.A))*180/Math.PI-(parseFloat(item.b)/2)).toFixed(2);//Q=arctan[(H-Y)/A] - b/2
              item["Z"]=(parseFloat(item.P)+parseFloat(item.G)-20*Math.log10(parseFloat(item.F))-20*Math.log10(parseFloat(item.A)/Math.cos(parseFloat(item.Q)*Math.PI/180)/1000)-32.45).toFixed(2);//Z=P+G-20lgF-20lg(A/1000)-32.45

              $(tr).find("td:eq(10)").html(item["Q"]);
              $(tr).find("td:eq(11)").html(item["Z"]);

              dataSet[index]=item;

              console.log(dataSet);


              layer.closeAll();
            });
          }
        }
        /*删除数组中的某一个对象
        _arr:数组
        _obj:需删除的对象
        */
        function removeArray(_arr, _obj) {
          var length = _arr.length;
          for (var i = 0; i < length; i++) {
            if (_arr[i].number == _obj.number) {
              if (i == 0) {
                _arr.shift(); //删除并返回数组的第一个元素
                return _arr;
              }
              else if (i == length - 1) {
                _arr.pop();  //删除并返回数组的最后一个元素
                return _arr;
              }
              else {
                _arr.splice(i, 1); //删除下标为i的元素
                return _arr;
              }
            }
          }
        }

        /**
         * 获取对象
         * @param number
         * @returns {*}
         */
        function getItem(number) {
          let index=getIndex(dataSet,{number:number});
          return dataSet[index];
        }

        function getIndex (_arr,_obj) {
          var len = _arr.length;
          for(var i = 0; i < len; i++)
          {
            if(_arr[i].number == _obj.number)
            {
              return parseInt(i);
            }
          }
          return -1;
        };
      });
    </script>
  </body>
</html>
